{% extends "admin/base_site.html" %}
{% block content %}
<h1>Bank Reports</h1>
<form method="get" style="margin-bottom:20px;">
    <label for="year">Year:</label>
    <select name="year" id="year" onchange="this.form.submit()">
        <option value="any" {% if selected_year == 'any' %}selected{% endif %}>Any</option>
        {% for y in years %}
            <option value="{{ y }}" {% if selected_year == y|stringformat:"s" %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
    </select>
    <label for="start_date">Start date:</label>
    <input type="date" id="start_date" name="start_date" value="{{ start_date }}" onchange="this.form.submit()">

    <label for="end_date">End date:</label>
    <input type="date" id="end_date" name="end_date" value="{{ end_date }}" onchange="this.form.submit()">
</form>
<div style="margin-bottom:8px;">
    <button id="exportPdf" type="button">Export PDF</button>
</div>

<table class="results">
    <thead>
        <tr>
            <th>Year</th>
            <th>Month</th>
            <th>Amount</th>
        </tr>
    </thead>
    <tbody id="ledgerBody">
        <!-- rows will be populated by JS -->
    </tbody>
    <tfoot>
        <tr>
            <th colspan="2" style="text-align:right;">Totals:</th>
            <th id="totalAmount">{{ total_amount }}</th>
        </tr>
    </tfoot>
</table>

<div style="width:100%;max-width:800px;">
    <canvas id="saddqahChart"></canvas>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const rows = {{ rows|safe }};

// Bank Chart
new Chart(document.getElementById('saddqahChart'), {
    type: 'bar',
    data: {
        labels: rows.map(r => `${r.month} ${r.year}`),
        datasets: [{
            label: 'Total Bank Amount',
            data: rows.map(r => r.amount),
            backgroundColor: 'rgba(54, 162, 235, 0.5)'
        }]
    },
    options: {
        responsive: true,
        scales: {
            x: { stacked: false },
            y: { beginAtZero: true }
        }
    }
});

// populate table rows
(function populateTable(){
    const tbody = document.getElementById('ledgerBody');
    tbody.innerHTML = '';
    rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.year}</td><td>${r.month}</td><td>${r.amount}</td>`;
        tbody.appendChild(tr);
    });
})();

// export PDF button: navigate to export endpoint preserving query string
document.getElementById('exportPdf').addEventListener('click', function(){
    const base = window.location.pathname.endsWith('/') ? window.location.pathname : window.location.pathname + '/';
    const exportUrl = base + 'export_pdf/' + window.location.search;
    window.location.href = exportUrl;
});
</script>
{% endblock %}