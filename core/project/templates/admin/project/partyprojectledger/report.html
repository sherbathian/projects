{% extends "admin/base_site.html" %}
{% block content %}
<h1>Party Project Ledger</h1>
<form method="get" style="margin-bottom:12px;">
    <label for="project">Project:</label>
    <select name="project" id="project" onchange="this.form.submit()">
        <option value="any" {% if selected_project == 'any' %}selected{% endif %}>Any</option>
        {% for p in projects %}
            <option value="{{ p.id }}" {% if selected_project == p.id|stringformat:"s" %}selected{% endif %}>{{ p.name }}</option>
        {% endfor %}
    </select>

    <label for="party">Party:</label>
    <select name="party" id="party" onchange="this.form.submit()">
        <option value="any" {% if selected_party == 'any' %}selected{% endif %}>Any</option>
        {% for pa in parties %}
            <option value="{{ pa.id }}" {% if selected_party == pa.id|stringformat:"s" %}selected{% endif %}>{{ pa.name }}</option>
        {% endfor %}
    </select>

    <label for="year">Year:</label>
    <select name="year" id="year" onchange="this.form.submit()">
        <option value="any" {% if selected_year == 'any' %}selected{% endif %}>Any</option>
        {% for y in years %}
            <option value="{{ y }}" {% if selected_year == y|stringformat:"s" %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
    </select>

    <label for="start_date">Start date:</label>
    <input type="date" id="start_date" name="start_date" value="{{ start_date }}" onchange="this.form.submit()">

    <label for="end_date">End date:</label>
    <input type="date" id="end_date" name="end_date" value="{{ end_date }}" onchange="this.form.submit()">
</form>
<div style="margin-bottom:8px;">
    <button id="exportPdf" type="button">Export PDF</button>
</div>
<p>
    <strong>Project:</strong> {{ selected_project_name }} &nbsp; | &nbsp;
    <strong>Party:</strong> {{ selected_party_name }} &nbsp; | &nbsp;
    <strong>Year:</strong> {{ selected_year_label }}{% if start_date or end_date %} &nbsp; | &nbsp; <strong>Date Range:</strong> {{ start_date|default:"Any" }} - {{ end_date|default:"Any" }}{% endif %}
</p>
<table class="results">
    <thead>
        <tr>
            <th>Year</th>
            <th>Month</th>
            <th>Received Amount</th>
            <th>Paid Amount</th>
            <th>Withdrawn Amount</th>
            <th>Balance Amount</th>
        </tr>
    </thead>
    <tbody id="ledgerBody">
        <!-- rows will be populated by JS -->
    </tbody>
    <tfoot>
        <tr>
            <th colspan="2" style="text-align:right;">Totals:</th>
            <th id="totalReceived">{{ total_received_all }}</th>
            <th id="totalPaid">{{ total_paid_all }}</th>
            <th id="totalWithdrawn">{{ total_withdrawn_all }}</th>
            <th id="totalBalance">{{ total_balance_all }}</th>
        </tr>
    </tfoot>
</table>
<p>
    <strong>Project:</strong> {{ selected_project_name }} &nbsp; | &nbsp;
    <strong>Party:</strong> {{ selected_party_name }} &nbsp; | &nbsp;
    <strong>Year:</strong> {{ selected_year_label }}{% if start_date or end_date %} &nbsp; | &nbsp; <strong>Date Range:</strong> {{ start_date|default:"Any" }} - {{ end_date|default:"Any" }}{% endif %}
</p>
<div style="width:100%;max-width:900px;margin-top:40px;">
    <canvas id="receivedChart"></canvas>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const rows = {{ rows|safe }};

// draw chart (labels are "Month Year")
new Chart(document.getElementById('receivedChart'), {
    type: 'bar',
    data: {
        labels: rows.map(r => `${r.month} ${r.year}`),
        datasets: [{
            label: 'Received',
            data: rows.map(r => r.received),
            backgroundColor: 'rgba(255, 99, 132, 0.5)'
        },
        {
            label: 'Paid',
            data: rows.map(r => r.paid),
            backgroundColor: 'rgba(117, 99, 255, 0.5)'
        },
        {
            label: 'Withdrawn',
            data: rows.map(r => r.withdrawn),
            backgroundColor: 'rgba(201, 198, 226, 0.68)'
        },
        {
            label: 'Balance',
            data: rows.map(r => r.balance),
            backgroundColor: 'rgba(82, 223, 155, 0.5)'
        }]
    },
    options: {
        responsive: true,
        scales: {
            x: { stacked: false },
            y: { beginAtZero: true }
        }
    }
});

// populate table rows
(function populateTable(){
    const tbody = document.getElementById('ledgerBody');
    tbody.innerHTML = '';
    rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.year}</td><td>${r.month}</td><td>${r.received}</td><td>${r.paid}</td><td>${r.withdrawn}</td><td>${r.balance}</td>`;
        tbody.appendChild(tr);
    });
})();

// export PDF button: navigate to export endpoint preserving query string
document.getElementById('exportPdf').addEventListener('click', function(){
    // current path should be e.g. /admin/report/party-project-ledger/
    const base = window.location.pathname.endsWith('/') ? window.location.pathname : window.location.pathname + '/';
    const exportUrl = base + 'export_pdf/' + window.location.search;
    window.location.href = exportUrl;
});
</script>
{% endblock %}